
#####################################
########## RUNNING BISMARK ##########
#####################################


#choose the genome you're working with
source /work/02260/grovesd/lonestar/myReferences/humanReference.sh   #human
source /work/02260/grovesd/lonestar/myReferences/chimpReference.sh   #chimp
source /work/02260/grovesd/lonestar/myReferences/macaqueRference.sh  #macaque


#check
echo $GENOME_FOLDER


#FOR SINGLE END
module load bowtie
module load samtools
>runBismark
for file in *.trim
do echo "bismark --bowtie2 --multicore 4 --genome $GENOME_FOLDER $file" >> runBismark
done



launcher_creator.py -n runBismarkMacac -j runBismark -q normal -N 8 -w 2 -a $allo -t 30:00:00 -e $email



#REMOVE DUPLICATES
module load samtools
>dedup
for file in *_bismark_bt2.bam 
do echo "/work/02260/grovesd/stampede2/Bismark/deduplicate_bismark --single --bam $file" >> dedup
done

launcher_creator.py -n dedupChimp -j dedup -q normal -N 4 -w 4 -a $allo -t 16:00:00

#look at results
grep "Total count of deduplicated leftover sequences" *.deduplication_report.txt


#EXTRACT THE METHYLATION RESULTS
module load samtools
>extractMeth
for file in *.deduplicated.bam
do echo "bismark_methylation_extractor --multicore 4 $file --merge_non_CpG --scaffolds --comprehensive --cytosine_report --genome_folder $GENOME_FOLDER" >> extractMeth
done

#note wayness of 1 seems better here because so many temp files are output for scaffolds during cov writing 
launcher_creator.py -n extractHumanQuick -j extractMeth -q normal -N 2 -w 1 -a $allo -e $email -t 2:00:00






#############################################
############## PIPELINE COUNTS ##############
#############################################

#RAW COUNTS
wc -l *.fastq |\
 awk '{split($2, a, ".fastq")
 print a[1]"\t"$1/4"\trawCounts"}' |\
 grep -v total > raw_read_counts.tsv &



#POST TRIMMING READ COUNT
wc -l *.trim |\
 awk '{split($2, a, ".trim")
 print a[1]"\t"$1/4"\ttrimmedCounts"}' |\
 grep -v total > trimmed_read_counts.tsv &

>all_bisulfite_reports.txt
for file in *PE_report.txt
do echo -e "${file}....\n" >> all_reports.txt; cat $file >> all_bisulfite_reports.txt
echo -e "\n\n---------------------------------------------------" >> all_bisulfite_reports.txt
done


#TOTAL READS GOING INTO BISMARK
>bismark_starting_reads.tsv
for file in *PE_report.txt
do count=$(grep "Sequence pairs analysed in total" $file | cut -f 2)
sample=${file/.trim_bismark_bt2_SE_report.txt/}
echo -e "${sample}\t${count}\tstartingCount" >> bismark_starting_reads.tsv
done


#TOTAL MAPPED COUNTS
>bismark_mapped_counts.tsv
for file in *_SE_report.txt
do mapped=$(grep "alignments with a unique best" $file | cut -f 2)
sample=${file/_catted_1.trim_bismark_bt2_SE_report.txt/}
echo -e "${sample}\t${mapped}\tmappedCount" >> bismark_mapped_counts.tsv
done


#MAPPING EFFICIENCIES
>bismark_mapping_efficiencies.txt
for file in *_SE_report.txt
do mapeff=$(grep "Mapping efficiency" $file | cut -f 2)
echo -e "${file}\t${mapeff}" >> bismark_mapping_efficiencies.txt
done

#METH CONTEXT PERCENTAGES
echo -e "file\tCpG.pct\tCHG.pct\tCHH.pct\tCN_or_CHH">methylation_context_percentages.txt
for file in *SE_report.txt
do cpg=$(grep "C methylated in CpG context:" $file | cut -f 2)
chg=$(grep "C methylated in CHG context:" $file | cut -f 2)
chh=$(grep "C methylated in CHH context:" $file | cut -f 2)
unkown=$(grep "C methylated in unknown context" $file | cut -f 2)
echo -e "$file\t$cpg\t$chg\t$chh\t$unknown" >> methylation_context_percentages.txt
done

#DEDUPLICATED COUNT
>bismark_dedup_count.txt
for file in *.deduplication_report.txt
do count=$(grep "leftover sequences" $file | awk '{print $7}')
echo -e "${file}\t${count}\tdedupCount" >> bismark_dedup_count.txt
done


#assemble results
cat bismark_starting_reads.tsv bismark_mapped_counts.tsv bismark_dedup_count.txt > pipeline_counts.txt 
